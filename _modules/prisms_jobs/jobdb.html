

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>prisms_jobs.jobdb &mdash; prisms-jobs 4.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> prisms-jobs
          

          
          </a>

          
            
            
              <div class="version">
                4.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">prisms_jobs documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scripts/index.html">Command line scripts documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../help.html">Getting help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">prisms-jobs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../prisms_jobs.html">prisms_jobs</a> &raquo;</li>
        
      <li>prisms_jobs.jobdb</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for prisms_jobs.jobdb</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; JobDB class and associated functions and methods &quot;&quot;&quot;</span>
<span class="c1">#pylint: disable=too-many-lines</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">string_types</span>

<span class="kn">import</span> <span class="nn">prisms_jobs</span>
<span class="kn">from</span> <span class="nn">prisms_jobs</span> <span class="k">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">misc</span>

<span class="k">def</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">maxlen</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;..&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxlen</span> <span class="k">else</span> <span class="n">data</span>

<div class="viewcode-block" id="JobDBError"><a class="viewcode-back" href="../../api/prisms_jobs.JobDBError.html#prisms_jobs.JobDBError">[docs]</a><span class="k">class</span> <span class="nc">JobDBError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Custom error class for JobDB&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JobDBError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span></div>


<div class="viewcode-block" id="EligibilityError"><a class="viewcode-back" href="../../api/prisms_jobs.EligibilityError.html#prisms_jobs.EligibilityError">[docs]</a><span class="k">class</span> <span class="nc">EligibilityError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Custom error class for JobDB &quot;&quot;&quot;</span>  <span class="c1">#pylint: disable=fixme</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span> <span class="o">=</span> <span class="n">jobid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EligibilityError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span></div>


<span class="c1"># columns in database (see job_status_dict()):</span>
<span class="c1"># username, hostname, jobid, jobname, rundir, jobstatus, auto, taskstatus,</span>
<span class="c1"># continuation_jobid, qsubstr, qstatstr, nodes, proc, walltime, starttime,</span>
<span class="c1"># completiontime, elapsedtime</span>

<span class="c1"># allowed values (not checked at this time):</span>
<span class="c1"># taskstatus = [&quot;Incomplete&quot;,&quot;Complete&quot;,&quot;Continued&quot;,&quot;Check&quot;,&quot;Error:.*&quot;,&quot;Aborted&quot;]</span>
<span class="c1"># jobstatus = [&quot;C&quot;,&quot;Q&quot;,&quot;R&quot;,&quot;E&quot;,&quot;W&quot;,&quot;H&quot;,&quot;M&quot;]</span>
<span class="c1"># auto=[1,0]</span>

<span class="k">def</span> <span class="nf">job_status_dict</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">misc</span><span class="o">.</span><span class="n">getlogin</span><span class="p">(),</span>        <span class="c1">#pylint: disable=too-many-arguments, too-many-locals</span>
                    <span class="n">hostname</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span>
                    <span class="n">jobid</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">rundir</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">jobstatus</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">auto</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">taskstatus</span><span class="o">=</span><span class="s2">&quot;Incomplete&quot;</span><span class="p">,</span>
                    <span class="n">continuation_jobid</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">qsubstr</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">qstatstr</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">procs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">walltime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">elapsedtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">starttime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">completiontime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a dict() with job_status fields.</span>

<span class="sd">       This is used to add records to the JobDB database through JobDB().add().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">creationtime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">modifytime</span> <span class="o">=</span> <span class="n">creationtime</span>

    <span class="n">status</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hostname</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobid</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;jobname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobname</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;rundir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rundir</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;jobstatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobstatus</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">auto</span><span class="p">))</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">taskstatus</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">continuation_jobid</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;qsubstr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qsubstr</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;qstatstr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qstatstr</span>

    <span class="c1"># integer:</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;procs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">procs</span>

    <span class="c1"># integer s:</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;walltime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walltime</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;elapsedtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsedtime</span>

    <span class="c1"># integer s since the epoch:</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;creationtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">creationtime</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;starttime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">starttime</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;completiontime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">completiontime</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;modifytime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modifytime</span>

    <span class="k">return</span> <span class="n">status</span>


<span class="c1">#def selector_rules():</span>
<span class="c1">#    rules = dict()</span>
<span class="c1">#    rules[&quot;username&quot;] = lambda r: r[&quot;username&quot;]</span>
<span class="c1">#    rules[&quot;hostname&quot;] = lambda r: r[&quot;hostname&quot;]</span>
<span class="c1">#    rules[&quot;jobid&quot;] = lambda r: r[&quot;jobid&quot;]</span>
<span class="c1">#    rules[&quot;rundir&quot;] = lambda r: r[&quot;rundir&quot;]</span>
<span class="c1">#    rules[&quot;jobstatus&quot;] = lambda r: r[&quot;jobstatus&quot;]</span>
<span class="c1">#    rules[&quot;auto&quot;] = lambda r: r[&quot;auto&quot;]</span>
<span class="c1">#    rules[&quot;taskstatus&quot;] = lambda r: r[&quot;taskstatus&quot;]</span>
<span class="c1">#    rules[&quot;continuation_jobid&quot;] = lambda r: r[&quot;continuation_jobid&quot;]</span>
<span class="c1">#    rules[&quot;qsubstr&quot;] = lambda r: r[&quot;continuation_jobid&quot;]</span>
<span class="c1">#    ...</span>
<span class="c1">#    return rules</span>


<span class="k">def</span> <span class="nf">job_status_type_dict</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This specifies the SQL type for each field.</span>
<span class="sd">       It is used to create the JobDB SQL table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">job_status_dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
        <span class="n">status</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>

    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;procs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>

    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;walltime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;elapsedtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>

    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;creationtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;starttime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;completiontime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>
    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;modifytime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>

    <span class="k">return</span> <span class="n">status</span>


<span class="k">def</span> <span class="nf">sql_create_str</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns a string for SQL CREATE TABLE&quot;&quot;&quot;</span>
    <span class="n">status_type</span> <span class="o">=</span> <span class="n">job_status_type_dict</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span>    <span class="c1">#pylint: disable=invalid-name</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">status_type</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">status_type</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span>  <span class="c1">#pylint: disable=invalid-name</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>


<span class="k">def</span> <span class="nf">sql_insert_str</span><span class="p">(</span><span class="n">job_status</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Accepts job_status dict, Returns strings and tuple used for SQL INSERT INTO.&quot;&quot;&quot;</span>
    <span class="n">job_status</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">job_status</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]))</span>
    <span class="n">colstr</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span>
    <span class="n">questionstr</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">:</span>
        <span class="n">colstr</span> <span class="o">=</span> <span class="n">colstr</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span>
        <span class="n">questionstr</span> <span class="o">=</span> <span class="n">questionstr</span> <span class="o">+</span> <span class="s2">&quot;?, &quot;</span>
        <span class="n">val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_status</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">colstr</span> <span class="o">=</span> <span class="n">colstr</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="n">questionstr</span> <span class="o">=</span> <span class="n">questionstr</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="k">return</span> <span class="n">colstr</span><span class="p">,</span> <span class="n">questionstr</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CompatibilityRow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Python2/3 compatibility wrapper of sqlite3.Row&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row</span> <span class="o">=</span> <span class="n">row</span>
    
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sql_iter</span><span class="p">(</span><span class="n">curs</span><span class="p">,</span> <span class="n">arraysize</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Iterate over the results of a SELECT statement &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">curs</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="n">arraysize</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>       <span class="c1">#pylint: disable=invalid-name</span>
                <span class="k">yield</span> <span class="n">CompatibilityRow</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Regexp to bool wrapper&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="JobDB"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB">[docs]</a><span class="k">class</span> <span class="nc">JobDB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>    <span class="c1">#pylint: disable=too-many-instance-attributes, too-many-public-methods</span>
    <span class="sd">&quot;&quot;&quot;A primsms_jobs Job Database object</span>
<span class="sd">    </span>
<span class="sd">    Usually this is called without arguments (prisms_jobs.JobDB()) to open or </span>
<span class="sd">    create a database in the default location.</span>
<span class="sd">            </span>
<span class="sd">    Args:</span>
<span class="sd">        dbpath (str, optional): Path to JobDB sqlite database. By default,</span>
<span class="sd">            uses ``prisms_jobs.config.dbpath()``.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="JobDB.__init__"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>

        <span class="c1"># list of dict() from misc.job_status for jobs not tracked in database:</span>
        <span class="c1"># refreshed upon update()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">untracked</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="JobDB.connect"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>    <span class="c1">#pylint: disable=too-many-branches, too-many-statements</span>
        <span class="sd">&quot;&quot;&quot;Open a connection to the jobs database.</span>

<span class="sd">        Args:</span>
<span class="sd">            dbpath (str, optional): path to a JobDB database file. By default,</span>
<span class="sd">            uses ``prisms_jobs.config.dbpath()``.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">dbpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dbpath</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dbpath</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dbpath</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating Database:&quot;</span><span class="p">,</span> <span class="n">dbpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s2">&quot;REGEXP&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">regexp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE jobs &quot;</span> <span class="o">+</span> <span class="n">sql_create_str</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s2">&quot;REGEXP&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">regexp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            
            <span class="c1"># check columns</span>
            <span class="n">status_type</span> <span class="o">=</span> <span class="n">job_status_type_dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * from jobs&quot;</span><span class="p">)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">status_type</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Column &#39;&quot;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;&#39; not in prisms_jobs jobs table.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.close"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the connection to the jobs database.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="JobDB.add"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a record to the jobs database.</span>

<span class="sd">        Args:</span>
<span class="sd">            job_status (dict):</span>
<span class="sd">                Accepts a dictionary of data comprising the record. </span>
<span class="sd">                Create ``job_status`` using prisms_jobs.jobdb.job_status_dict().</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">colstr</span><span class="p">,</span> <span class="n">questionstr</span><span class="p">,</span> <span class="n">valtuple</span><span class="p">)</span> <span class="o">=</span> <span class="n">sql_insert_str</span><span class="p">(</span><span class="n">job_status</span><span class="p">)</span>
        <span class="n">insertstr</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO jobs </span><span class="si">{0}</span><span class="s2"> VALUES </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colstr</span><span class="p">,</span> <span class="n">questionstr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insertstr</span><span class="p">,</span> <span class="n">valtuple</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="JobDB.update"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update records using qstat.</span>

<span class="sd">        Any jobs found using qstat that are not in the jobs database are saved </span>
<span class="sd">        in &#39;self.untracked&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># update jobstatus</span>
        <span class="c1"># * this method can be configured/customized via set_update_selection_method</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update_selection_method</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">)</span>

        <span class="c1"># newstatus will contain the updated info</span>
        <span class="n">newstatus</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># any jobs that we don&#39;t find with qstat should be marked as &#39;C&#39;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="n">newstatus</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>

        <span class="c1"># get job_status dict for all jobs found with qstat</span>
        <span class="n">active_status</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">software</span><span class="p">()</span><span class="o">.</span><span class="n">job_status</span><span class="p">()</span>

        <span class="c1"># reset untracked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">untracked</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># collect job status</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">active_status</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">newstatus</span><span class="p">:</span>
                <span class="n">newstatus</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">active_status</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid FROM jobs WHERE jobid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">untracked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">active_status</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="c1"># update database with latest job status</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">jobstatus</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">newstatus</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">jobstatus</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;UPDATE jobs SET jobstatus=?, elapsedtime=?, modifytime=? WHERE jobid=?&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">key</span><span class="p">))</span>
            <span class="c1">#elif jobstatus[&quot;qstatstr&quot;] is None:</span>
            <span class="c1">#    self.curs.execute(</span>
            <span class="c1">#    &quot;UPDATE jobs SET jobstatus=?, elapsedtime=?, modifytime=? WHERE jobid=?&quot;,</span>
            <span class="c1">#    (jobstatus[&quot;jobstatus&quot;], jobstatus[&quot;elapsedtime&quot;], int(time.time()), key))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;UPDATE jobs SET jobstatus=?, elapsedtime=?, starttime=?,</span><span class="se">\</span>
<span class="s2">                     completiontime=?, qstatstr=?, modifytime=? WHERE jobid=?&quot;</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="n">jobstatus</span><span class="p">[</span><span class="s2">&quot;jobstatus&quot;</span><span class="p">],</span> <span class="n">jobstatus</span><span class="p">[</span><span class="s2">&quot;elapsedtime&quot;</span><span class="p">],</span>
                        <span class="n">jobstatus</span><span class="p">[</span><span class="s2">&quot;starttime&quot;</span><span class="p">],</span> <span class="n">jobstatus</span><span class="p">[</span><span class="s2">&quot;completiontime&quot;</span><span class="p">],</span>
                        <span class="n">jobstatus</span><span class="p">[</span><span class="s2">&quot;qstatstr&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">key</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># update taskstatus for non-auto jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE jobs SET taskstatus=&#39;Check&#39;, modifytime=? </span><span class="se">\</span>
<span class="s2">            WHERE jobstatus=&#39;C&#39; AND taskstatus=&#39;Incomplete&#39; AND auto=0&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="JobDB.select_job"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_job">[docs]</a>    <span class="k">def</span> <span class="nf">select_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return record (sqlite3.Row object) for one job with given jobid.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in prisms_jobs.JobDB.select_job(). type(id):&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">jobid</span><span class="p">),</span> <span class="s2">&quot;expected str.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM jobs WHERE jobid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>    <span class="c1">#pylint: disable=invalid-name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JobDBError</span><span class="p">(</span><span class="s2">&quot;Error in prisms_jobs.JobDB.select_job(). jobid: &#39;&quot;</span>
                             <span class="o">+</span> <span class="n">jobid</span> <span class="o">+</span> <span class="s2">&quot;&#39; not found in jobs database.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JobDBError</span><span class="p">(</span><span class="s2">&quot;Error in prisms_jobs.JobDB.select_job(). &quot;</span>
                             <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; records with jobid: &#39;&quot;</span>
                             <span class="o">+</span> <span class="n">jobid</span> <span class="o">+</span> <span class="s2">&quot;&#39; found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CompatibilityRow</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="JobDB.select_series"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_series">[docs]</a>    <span class="k">def</span> <span class="nf">select_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return records (sqlite3.Row objects) for a series of auto jobs&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>  <span class="c1">#pylint: disable=invalid-name</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_parent</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">series</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_child</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_child</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">series</span></div>


<div class="viewcode-block" id="JobDB.select_parent"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_parent">[docs]</a>    <span class="k">def</span> <span class="nf">select_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return record for the parent of a job</span>

<span class="sd">           The parent is the job with continuation_jobid = given jobid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in prisms_jobs.JobDB.select_parent(). type(id):&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">jobid</span><span class="p">),</span> <span class="s2">&quot;expected str.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM jobs WHERE continuation_jobid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>    <span class="c1">#pylint: disable=invalid-name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Error in prisms_jobs.JobDB.select_parent().&quot;</span><span class="p">,</span>
                   <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">),</span>
                   <span class="s2">&quot; records with continuation_jobid:&quot;</span><span class="p">,</span>
                   <span class="n">jobid</span><span class="p">,</span> <span class="s2">&quot; found.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">CompatibilityRow</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="JobDB.select_child"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_child">[docs]</a>    <span class="k">def</span> <span class="nf">select_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return record for the child of a job</span>

<span class="sd">           The child is the job whose jobid = continuation_jobid of job with given jobid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>  <span class="c1">#pylint: disable=invalid-name</span>

        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM jobs WHERE jobid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">],))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>    <span class="c1">#pylint: disable=invalid-name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Error in prisms_jobs.JobDB.select_child(). jobid:&quot;</span><span class="p">,</span>
                   <span class="n">jobid</span><span class="p">,</span> <span class="s2">&quot; child:&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">],</span>
                   <span class="s2">&quot;not found.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Error in prisms_jobs.JobDB.select_child().&quot;</span><span class="p">,</span>
                   <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="s2">&quot; records with child jobid:&quot;</span><span class="p">,</span>
                   <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">],</span> <span class="s2">&quot; found.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">CompatibilityRow</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>



<div class="viewcode-block" id="JobDB.select_all_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_all_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_all_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list with all jobids.&quot;&quot;&quot;</span>
        <span class="n">job</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid FROM jobs&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="n">job</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">job</span></div>


<div class="viewcode-block" id="JobDB.select_all_active_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_all_active_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_all_active_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list with all active jobids.</span>

<span class="sd">           &quot;Active&quot; jobs are those with taskstatus=&#39;Incomplete&#39; or &#39;Check&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_job</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid FROM jobs WHERE taskstatus!=&#39;Complete&#39;</span><span class="se">\</span>
<span class="s2">                           AND taskstatus!=&#39;Aborted&#39; AND taskstatus!=&#39;Continued&#39;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="n">active_job</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">active_job</span></div>


<div class="viewcode-block" id="JobDB.select_range_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_range_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_range_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_jobid</span><span class="p">,</span> <span class="n">max_jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of all jobids which are between (and including)</span>
<span class="sd">                min_jobid and max_jobid. &quot;&quot;&quot;</span>
        <span class="n">job</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid FROM jobs&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_jobid</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_jobid</span><span class="p">):</span>
                <span class="n">job</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">job</span></div>


<div class="viewcode-block" id="JobDB.select_recent_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_recent_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_recent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recent_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of all jobids which were modified in the last &#39;recent_time&#39; &quot;&quot;&quot;</span>
        <span class="n">mintime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">misc</span><span class="o">.</span><span class="n">seconds</span><span class="p">(</span><span class="n">recent_time</span><span class="p">))</span>
        <span class="n">recent_job</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid FROM jobs WHERE modifytime&gt;=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mintime</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="n">recent_job</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">recent_job</span></div>


<div class="viewcode-block" id="JobDB.select_regex_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_regex_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_regex_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of all jobids in which the column &#39;key&#39; matches the</span>
<span class="sd">                regular expression &#39;regex&#39; &quot;&quot;&quot;</span>
        <span class="n">job</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job_status_dict</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid FROM jobs WHERE &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; REGEXP ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
                <span class="n">job</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JobDBError</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; not a valid key&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job</span></div>


<div class="viewcode-block" id="JobDB.select_series_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_series_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_series_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list with all jobids for a series of auto jobs.&quot;&quot;&quot;</span>
        <span class="n">job</span> <span class="o">=</span> <span class="p">[</span><span class="n">jobid</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>  <span class="c1">#pylint: disable=invalid-name, unused-variable</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_parent</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_child</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_child</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">job</span></div>


<div class="viewcode-block" id="JobDB.select_all_series_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_all_series_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_all_series_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of lists of jobids (one list for each series).&quot;&quot;&quot;</span>
        <span class="n">all_series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM jobs&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">all_series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_series_id</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">all_series</span></div>


<div class="viewcode-block" id="JobDB.select_active_series_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_active_series_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_active_series_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of lists of jobids (one list for each active series).</span>

<span class="sd">           &quot;Active&quot; series of auto jobs are those with one job with</span>
<span class="sd">                taskstatus=&#39;Incomplete&#39; or &#39;Check&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid, continuation_jobid FROM jobs WHERE</span><span class="se">\</span>
<span class="s2">                           taskstatus!=&#39;Complete&#39; AND taskstatus!=&#39;Aborted&#39;</span><span class="se">\</span>
<span class="s2">                           AND taskstatus!=&#39;Continued&#39;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">active_series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_series_id</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">active_series</span></div>


<div class="viewcode-block" id="JobDB.select_range_series_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_range_series_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_range_series_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_jobid</span><span class="p">,</span> <span class="n">max_jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of lists of all jobids for series (one list for each series)</span>
<span class="sd">            which have the last job between (and including) min_jobid and max_jobid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid, continuation_jobid FROM jobs&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_jobid</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_jobid</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_series_id</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">job</span></div>


<div class="viewcode-block" id="JobDB.select_recent_series_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_recent_series_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_recent_series_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recent_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of lists of jobids (one for each series) which were</span>
<span class="sd">                modified in the last &#39;recent_time&#39; &quot;&quot;&quot;</span>
        <span class="n">mintime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">misc</span><span class="o">.</span><span class="n">seconds</span><span class="p">(</span><span class="n">recent_time</span><span class="p">))</span>
        <span class="n">recent_job</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid FROM jobs WHERE modifytime&gt;=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mintime</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">recent_job</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_series_id</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">recent_job</span></div>


<div class="viewcode-block" id="JobDB.select_regex_series_id"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.select_regex_series_id">[docs]</a>    <span class="k">def</span> <span class="nf">select_regex_series_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of lists of jobids (one for each series) in which the column</span>
<span class="sd">            &#39;key&#39; matches the regular expression &#39;regex&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">job</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span>  <span class="n">key</span> <span class="ow">in</span> <span class="n">job_status_dict</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid FROM jobs WHERE &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; REGEXP ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">regex</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_series_id</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JobDBError</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; not a valid key&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job</span></div>



<div class="viewcode-block" id="JobDB.eligible_to_continue"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.eligible_to_continue">[docs]</a>    <span class="k">def</span> <span class="nf">eligible_to_continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>    <span class="c1">#pylint: disable=no-self-use</span>
        <span class="sd">&quot;&quot;&quot; Return True if job is eligible to be continued, else return False</span>

<span class="sd">        Job must have jobstatus=&quot;C&quot; and taskstatus=&quot;Incomplete&quot; and auto=1,</span>
<span class="sd">            or else the job can not be continued.</span>

<span class="sd">        Args:</span>
<span class="sd">            job: a sqlite3.Row, as obtained by self.select_job()</span>

<span class="sd">        Returns:</span>
<span class="sd">            (0, jobid, None) if eligible</span>
<span class="sd">            (1, jobid, msg) if not eligible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobstatus&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="s2">&quot;Job not eligible to continue. jobstatus = &quot;</span>
                    <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobstatus&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Incomplete&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="s2">&quot;Job not eligible to continue. taskstatus = &quot;</span>
                    <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="s2">&quot;Job not eligible to continue. auto = &quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">])))</span>

        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.continue_job"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.continue_job">[docs]</a>    <span class="k">def</span> <span class="nf">continue_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Resubmit one job with given jobid.</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid: jobid of the job to continue</span>
<span class="sd">            job: (sqlite3.Row) If this is given, jobid is not necessary and is ignored if given</span>

<span class="sd">        Raises:</span>
<span class="sd">            EligibilityError if job not eligible to be continued</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="n">eligible</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eligible_to_continue</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>  <span class="c1">#pylint: disable=invalid-name, redefined-builtin</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eligible</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EligibilityError</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="n">wd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>    <span class="c1">#pylint: disable=invalid-name</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;rundir&quot;</span><span class="p">])</span>

        <span class="n">new_jobid</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">software</span><span class="p">()</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">substr</span><span class="o">=</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;qsubstr&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE jobs SET taskstatus=&#39;Continued&#39;, modifytime=?,</span><span class="se">\</span>
<span class="s2">                           continuation_jobid=? WHERE jobid=?&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">new_jobid</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">job_status_dict</span><span class="p">(</span><span class="n">jobid</span><span class="o">=</span><span class="n">new_jobid</span><span class="p">,</span> <span class="n">jobname</span><span class="o">=</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobname&quot;</span><span class="p">],</span> <span class="n">rundir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                                 <span class="n">jobstatus</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">],</span> <span class="n">qsubstr</span><span class="o">=</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;qsubstr&quot;</span><span class="p">],</span>
                                 <span class="n">nodes</span><span class="o">=</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">],</span> <span class="n">procs</span><span class="o">=</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;procs&quot;</span><span class="p">],</span> <span class="n">walltime</span><span class="o">=</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;walltime&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.continue_all"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.continue_all">[docs]</a>    <span class="k">def</span> <span class="nf">continue_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resubmit all jobs eligible to continue&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT jobid FROM jobs WHERE auto=1 AND</span><span class="se">\</span>
<span class="s2">                           taskstatus=&#39;Incomplete&#39; AND jobstatus=&#39;C&#39;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">continue_job</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="JobDB.eligible_to_abort"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.eligible_to_abort">[docs]</a>    <span class="k">def</span> <span class="nf">eligible_to_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>   <span class="c1">#pylint: disable=no-self-use</span>
        <span class="sd">&quot;&quot;&quot; Check if job is eligible to be aborted</span>

<span class="sd">        Jobs are eligible to be aborted if:</span>
<span class="sd">            jobstatus != &quot;C&quot;</span>
<span class="sd">            or</span>
<span class="sd">            (jobstatus == &quot;C&quot;</span>
<span class="sd">            and</span>
<span class="sd">            (taskstatus == &quot;Incomplete&quot; or taskstatus == &quot;Check&quot;))</span>

<span class="sd">        Args:</span>
<span class="sd">            job: a sqlite3.Row, as obtained by self.select_job()</span>

<span class="sd">        Returns:</span>
<span class="sd">            (0, jobid, None) if eligible</span>
<span class="sd">            (1, jobid, msg) if not eligible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobstatus&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Incomplete&quot;</span> <span class="ow">or</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Check&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="s2">&quot;Job not eligible to be aborted. jobstatus = &quot;</span>
                <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobstatus&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; and taskstatus = &quot;</span> <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="JobDB.abort_job"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.abort_job">[docs]</a>    <span class="k">def</span> <span class="nf">abort_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete a job and mark job taskstatus as Aborted</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid: jobid of the job to continue</span>
<span class="sd">            job: (sqlite3.Row) If this is given, jobid is not necessary and is ignored if given</span>

<span class="sd">        Raises:</span>
<span class="sd">            EligibilityError if job not eligible to be aborted</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="n">eligible</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eligible_to_abort</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="c1">#pylint: disable=invalid-name, redefined-builtin</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eligible</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EligibilityError</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">software</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE jobs SET taskstatus=&#39;Aborted&#39;, modifytime=?</span><span class="se">\</span>
<span class="s2">                           WHERE jobid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="JobDB.eligible_to_delete"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.eligible_to_delete">[docs]</a>    <span class="k">def</span> <span class="nf">eligible_to_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>  <span class="c1">#pylint: disable=no-self-use</span>
        <span class="sd">&quot;&quot;&quot; Check if job is eligible to be aborted</span>

<span class="sd">        All jobs are eligible to be deleted</span>

<span class="sd">        Args:</span>
<span class="sd">            job: a sqlite3.Row, as obtained by self.select_job()</span>

<span class="sd">        Returns:</span>
<span class="sd">            (0, jobid, None) if eligible</span>
<span class="sd">            (1, jobid, msg) if not eligible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.delete_job"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.delete_job">[docs]</a>    <span class="k">def</span> <span class="nf">delete_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete job if running, and delete job from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid (str): jobid of the job to continue</span>
<span class="sd">            job (sqlite3.Row): If this is given, jobid is not necessary and is ignored if given</span>
<span class="sd">            series (bool): If &#39;series&#39;=True, deletes entire job series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">jobseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_series_id</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jobseries</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobseries</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">software</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE from jobs WHERE jobid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="JobDB.eligible_to_error"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.eligible_to_error">[docs]</a>    <span class="k">def</span> <span class="nf">eligible_to_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>   <span class="c1">#pylint: disable=no-self-use</span>
        <span class="sd">&quot;&quot;&quot; Check if job is eligible to be marked as error</span>

<span class="sd">        All jobs are eligible to be marked as error. (Should this exclude &quot;Continued&quot; jobs?)</span>

<span class="sd">        Args:</span>
<span class="sd">            job: a sqlite3.Row, as obtained by self.select_job()</span>

<span class="sd">        Returns:</span>
<span class="sd">            (0, jobid, None) if eligible</span>
<span class="sd">            (1, jobid, msg) if not eligible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.error_job"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.error_job">[docs]</a>    <span class="k">def</span> <span class="nf">error_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Mark job taskstatus as &#39;Error: message&#39;</span>

<span class="sd">        Any job can be marked as error.</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid: jobid of the job to mark as error</span>
<span class="sd">            job: (sqlite3.Row) If this is given, jobid is not necessary and is ignored if given</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Error: &quot;</span> <span class="o">+</span> <span class="n">message</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE jobs SET taskstatus=?, modifytime=? WHERE</span><span class="se">\</span>
<span class="s2">                           jobid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="JobDB.eligible_to_reset"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.eligible_to_reset">[docs]</a>    <span class="k">def</span> <span class="nf">eligible_to_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>   <span class="c1">#pylint: disable=no-self-use</span>
        <span class="sd">&quot;&quot;&quot; Check if job is eligible to be reset</span>

<span class="sd">        Jobs are eligible to be reset if they are &#39;auto&#39; jobs, and</span>
<span class="sd">            taskstatus == &quot;Error:.*&quot; or &quot;Aborted&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            job: a sqlite3.Row, as obtained by self.select_job()</span>

<span class="sd">        Returns:</span>
<span class="sd">            (0, jobid, None) if eligible</span>
<span class="sd">            (1, jobid, msg) if not eligible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="s2">&quot;Job not eligible to be reset. auto = &quot;</span> <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Aborted&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;Error:.*&quot;</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="s2">&quot;Job not eligible to be reset. taskstatus = &quot;</span>
                    <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.reset_job"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.reset_job">[docs]</a>    <span class="k">def</span> <span class="nf">reset_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Mark job taskstatus as &#39;Incomplete&#39;</span>

<span class="sd">        Jobs are eligible to be reset if they are &#39;auto&#39; jobs, and</span>
<span class="sd">            taskstatus == &quot;Error:.*&quot; or &quot;Aborted&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid: jobid of the job to mark as error</span>
<span class="sd">            job: (sqlite3.Row) If this is given, jobid is not necessary and is ignored if given</span>

<span class="sd">        Raises:</span>
<span class="sd">            prisms_jobs.EligibilityError: If not job not eligible to be marked &#39;Complete&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="n">eligible</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eligible_to_reset</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="c1">#pylint: disable=invalid-name, redefined-builtin</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eligible</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EligibilityError</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE jobs SET taskstatus=?, modifytime=? WHERE jobid=?&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="s2">&quot;Incomplete&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="JobDB.eligible_to_complete"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.eligible_to_complete">[docs]</a>    <span class="k">def</span> <span class="nf">eligible_to_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>    <span class="c1">#pylint: disable=no-self-use</span>
        <span class="sd">&quot;&quot;&quot; Check if job is eligible to be completed</span>

<span class="sd">        Jobs are eligible to be completed if:</span>
<span class="sd">            taskstatus != &quot;Complete&quot; and taskstatus != &quot;Continued&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            job: a sqlite3.Row, as obtained by self.select_job()</span>

<span class="sd">        Returns:</span>
<span class="sd">            (0, jobid, None) if eligible</span>
<span class="sd">            (1, jobid, msg) if not eligible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Incomplete&quot;</span> <span class="ow">or</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Check&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="s2">&quot;Job not eligible to be completed. taskstatus = &quot;</span>
                <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="JobDB.complete_job"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.complete_job">[docs]</a>    <span class="k">def</span> <span class="nf">complete_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark job taskstatus as &#39;Complete&#39;</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            jobid (str): ID of job</span>
<span class="sd">            job (sqlite3.Row object): Job record from database</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            prisms_jobs.EligibilityError: If not job not eligible to be marked &#39;Complete&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="n">eligible</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eligible_to_complete</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>  <span class="c1">#pylint: disable=invalid-name, redefined-builtin</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eligible</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EligibilityError</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE jobs SET taskstatus=&#39;Complete&#39;, modifytime=?, elapsedtime=?</span><span class="se">\</span>
<span class="s2">                           WHERE jobid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>




<div class="viewcode-block" id="JobDB.print_header"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.print_header">[docs]</a>    <span class="k">def</span> <span class="nf">print_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#pylint: disable=no-self-use</span>
        <span class="sd">&quot;&quot;&quot;Print header rows for record summary&quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;12}</span><span class="s2"> </span><span class="si">{1:&lt;24}</span><span class="s2"> </span><span class="si">{2:^5}</span><span class="s2"> </span><span class="si">{3:^5}</span><span class="s2"> </span><span class="si">{4:&gt;12}</span><span class="s2"> </span><span class="si">{5:^1}</span><span class="s2"> </span><span class="si">{6:&gt;12}</span><span class="s2"> </span><span class="si">{7:&lt;24}</span><span class="s2"> </span><span class="si">{8:^1}</span><span class="s2"> </span><span class="si">{9:&lt;12}</span><span class="s2">&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;JobID&quot;</span><span class="p">,</span> <span class="s2">&quot;JobName&quot;</span><span class="p">,</span> <span class="s2">&quot;Nodes&quot;</span><span class="p">,</span> <span class="s2">&quot;Procs&quot;</span><span class="p">,</span> <span class="s2">&quot;Walltime&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Runtime&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Task&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;ContJobID&quot;</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:-^12}</span><span class="s2"> </span><span class="si">{1:-^24}</span><span class="s2"> </span><span class="si">{2:-^5}</span><span class="s2"> </span><span class="si">{3:-^5}</span><span class="s2"> </span><span class="si">{4:-&gt;12}</span><span class="s2"> </span><span class="si">{5:-^1}</span><span class="s2"> </span><span class="si">{6:-&gt;12}</span><span class="s2"> </span><span class="si">{7:-&lt;24}</span><span class="s2"> </span><span class="si">{8:-^1}</span><span class="s2"> </span><span class="si">{9:-^12}</span><span class="s2">&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="JobDB._print_record"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB._print_record">[docs]</a>    <span class="k">def</span> <span class="nf">_print_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>  <span class="c1">#pylint: disable=invalid-name, no-self-use</span>
        <span class="sd">&quot;&quot;&quot;Print record summary</span>

<span class="sd">        Args:</span>
<span class="sd">            r (dict): a dict-like object containing: &quot;jobid&quot;, &quot;jobname&quot;, &quot;nodes&quot;, </span>
<span class="sd">                &quot;procs&quot;,  &quot;walltime&quot;, &quot;jobstatus&quot;, &quot;elapsedtime&quot;, &quot;taskstatus&quot;, </span>
<span class="sd">                &quot;auto&quot;, and &quot;continuation_jobid&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="c1">#pylint: disable=invalid-name</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;walltime&quot;</span><span class="p">,</span> <span class="s2">&quot;elapsedtime&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">strftimedelta</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;12}</span><span class="s2"> </span><span class="si">{1:&lt;24}</span><span class="s2"> </span><span class="si">{2:^5}</span><span class="s2"> </span><span class="si">{3:^5}</span><span class="s2"> </span><span class="si">{4:&gt;12}</span><span class="s2"> </span><span class="si">{5:^1}</span><span class="s2"> </span><span class="si">{6:&gt;12}</span><span class="s2"> </span><span class="si">{7:&lt;24}</span><span class="s2"> </span><span class="si">{8:^1}</span><span class="s2"> </span><span class="si">{9:&lt;12}</span><span class="s2">&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="n">trunc</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;jobname&quot;</span><span class="p">],</span><span class="mi">24</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;procs&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;walltime&quot;</span><span class="p">],</span>
                       <span class="n">d</span><span class="p">[</span><span class="s2">&quot;jobstatus&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;elapsedtime&quot;</span><span class="p">],</span> <span class="n">trunc</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">],</span><span class="mi">24</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">],</span>
                       <span class="n">d</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]))</span></div>


<div class="viewcode-block" id="JobDB._print_full_record"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB._print_full_record">[docs]</a>    <span class="k">def</span> <span class="nf">_print_full_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span> <span class="c1">#pylint: disable=invalid-name, no-self-use</span>
        <span class="sd">&quot;&quot;&quot;Print record as list of key-val pairs.</span>

<span class="sd">        Args:</span>
<span class="sd">            r (dict): a dict-like object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#Record:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span>    <span class="c1">#pylint: disable=invalid-name</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;\&quot;</span><span class="s2">&quot;</span> <span class="c1">#pylint: disable=invalid-name</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.print_job"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.print_job">[docs]</a>    <span class="k">def</span> <span class="nf">print_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print job with given jobid</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid (str): ID of job</span>
<span class="sd">            job (sqlite3.Row object): Job record from database</span>
<span class="sd">            full (bool): If True, print as key:val pair list, If (default) False,</span>
<span class="sd">                print single row summary in &#39;qstat&#39; style.</span>
<span class="sd">            series (bool): If True, print records as groups of auto submitting job</span>
<span class="sd">                series. If (default) False, print in order found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">jobid</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">]</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_series</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>    <span class="c1">#pylint: disable=invalid-name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_full_record</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>    <span class="c1">#pylint: disable=invalid-name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_record</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_full_record</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_record</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.print_selected"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.print_selected">[docs]</a>    <span class="k">def</span> <span class="nf">print_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch and print jobs selected with SQL SELECT statement using cursor &#39;curs&#39;.</span>


<span class="sd">        Args:</span>
<span class="sd">            curs: Fetch selected jobs from sqlite3 cursor &#39;curs&#39;. If no &#39;curs&#39;</span>
<span class="sd">                given, use self.curs.</span>
<span class="sd">            full (bool): If True, print as key:val pair list, If (default) False,</span>
<span class="sd">                print single row summary in &#39;qstat&#39; style.</span>
<span class="sd">            series (bool): If True, print records as groups of auto submitting job</span>
<span class="sd">                series. If (default) False, print in order found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">curs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">curs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curs</span>
        <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
                <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_job</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_full_record</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sql_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="p">):</span>   <span class="c1">#pylint: disable=invalid-name</span>
                <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_job</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">],</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_record</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.print_untracked"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.print_untracked">[docs]</a>    <span class="k">def</span> <span class="nf">print_untracked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print untracked jobs.</span>

<span class="sd">        Untracked jobs are stored in self.untracked after calling JobDB.update().</span>

<span class="sd">        Args:</span>
<span class="sd">            full (bool): If True, print as key:val pair list, If (default) False,</span>
<span class="sd">                print single row summary in &#39;qstat&#39; style.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Untracked:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">full</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_header</span><span class="p">()</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">untracked</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">rec</span><span class="p">:</span> <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;jobid&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sort</span><span class="p">:</span>  <span class="c1">#pylint: disable=invalid-name</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;continuation_jobid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;taskstatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Untracked&quot;</span>
            <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_full_record</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_record</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.print_all"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.print_all">[docs]</a>    <span class="k">def</span> <span class="nf">print_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print all jobs</span>

<span class="sd">        Args:</span>
<span class="sd">            full (bool): If True, print as key:val pair list, If (default) False,</span>
<span class="sd">                print single row summary in &#39;qstat&#39; style.</span>
<span class="sd">            series (bool): If True, print records as groups of auto submitting job</span>
<span class="sd">                series. If (default) False, print in order found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracked:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM jobs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">full</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_header</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_selected</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobDB.print_active"><a class="viewcode-back" href="../../api/prisms_jobs.JobDB.html#prisms_jobs.JobDB.print_active">[docs]</a>    <span class="k">def</span> <span class="nf">print_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print active jobs</span>

<span class="sd">        &quot;Active&quot; jobs are those with taskstatus=&#39;Incomplete&#39; or &#39;Check&#39;</span>

<span class="sd">        Args:</span>
<span class="sd">            full (bool): If True, print as key:val pair list. If (default) False,</span>
<span class="sd">                print single row summary in &#39;qstat&#39; style.</span>
<span class="sd">            series (bool): If True, print records as groups of auto submitting job</span>
<span class="sd">                series. If (default) False, print in order found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracked:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM jobs WHERE taskstatus!=&#39;Complete&#39;</span><span class="se">\</span>
<span class="s2">                           AND taskstatus!=&#39;Aborted&#39; AND taskstatus!=&#39;Continued&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">full</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_header</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_selected</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span></div></div>

<span class="c1"># end class JobDB</span>


<div class="viewcode-block" id="complete_job"><a class="viewcode-back" href="../../api/prisms_jobs.complete_job.html#prisms_jobs.complete_job">[docs]</a><span class="k">def</span> <span class="nf">complete_job</span><span class="p">(</span><span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,):</span>
    <span class="sd">&quot;&quot;&quot;Mark the job as &#39;Complete&#39; if possible</span>

<span class="sd">    Args:</span>
<span class="sd">        dbpath (str): Path to JobDB database. </span>
<span class="sd">        </span>
<span class="sd">            If not given, use default database.</span>
<span class="sd">        </span>
<span class="sd">        jobid (str): ID of job to mark &#39;Complete&#39;. </span>
<span class="sd">        </span>
<span class="sd">            If not given, uses current job ID determined from the environment.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        JobsError: If job ID could not be determined</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">JobDB</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>  <span class="c1">#pylint: disable=invalid-name</span>

    <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">software</span><span class="p">()</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">prisms_jobs</span><span class="o">.</span><span class="n">JobsError</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Could not determine jobid&quot;</span><span class="p">)</span>

    <span class="n">job</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>  <span class="c1">#pylint: disable=unused-variable</span>
    <span class="n">db</span><span class="o">.</span><span class="n">complete_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="error_job"><a class="viewcode-back" href="../../api/prisms_jobs.error_job.html#prisms_jobs.error_job">[docs]</a><span class="k">def</span> <span class="nf">error_job</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark the job as &#39;Error: message&#39; if possible</span>

<span class="sd">    Args:</span>
<span class="sd">        message (str): Error message to save in JobDB.</span>
<span class="sd">        </span>
<span class="sd">        dbpath (str, optional): Path to JobDB database. </span>
<span class="sd">        </span>
<span class="sd">            If not given, use default database.</span>
<span class="sd">        </span>
<span class="sd">        jobid (str, optional): ID of job to mark &#39;Error: message&#39;. </span>
<span class="sd">        </span>
<span class="sd">            If not given, uses current job ID determined from the environment.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        JobsError: If job ID could not be determined</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">JobDB</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>  <span class="c1">#pylint: disable=invalid-name</span>
    <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">software</span><span class="p">()</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">prisms_jobs</span><span class="o">.</span><span class="n">JobsError</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Could not determine jobid&quot;</span><span class="p">)</span>

    <span class="n">job</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">error_job</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, PRISMS Center and CASM Developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>